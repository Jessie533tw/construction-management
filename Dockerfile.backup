# 使用最簡單的 Node.js 方法
FROM node:18

WORKDIR /app

# 複製所有文件
COPY . .

# 清理並重新安裝
RUN rm -rf node_modules client/node_modules

# 安裝後端依賴
RUN npm install --legacy-peer-deps

# 安裝前端依賴
RUN cd client && npm install --legacy-peer-deps

# 生成 Prisma client
RUN npx prisma generate

# 建構後端
RUN npm run build

# 建構前端
RUN cd client && npm run build

# 創建 uploads 目錄
RUN mkdir -p uploads

EXPOSE 3001

CMD ["npm", "start"]